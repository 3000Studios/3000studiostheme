name: 3000 Studios â€” MASTER WordPress Theme Sync

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Sync Theme to IONOS (No Duplicates)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”¥ Checkout Repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Build Theme Package
        run: |
          mkdir -p dist
          rsync -av --exclude='.github' --exclude='node_modules' --exclude='dist' ./ dist/3000studiostheme-main/

      - name: ğŸ“¡ Deploy via SFTP (IONOS)
        uses: wlixcc/SFTP-Deploy-Action@v1.4.1
        with:
          server: ${{ secrets.IONOS_HOST }}
          username: ${{ secrets.IONOS_USER }}
          password: ${{ secrets.IONOS_PASS }}
          port: 22
          local_path: "dist/3000studiostheme-main/"
          remote_path: "/clickandbuilds/3000Studios/wp-content/themes/3000studiostheme-main"
          args: "-avz --delete"

      - name: ğŸ”§ Fix File Permissions
        run: |
          echo "chmod -R 755 wp-content" >> fix.sh
          echo "chmod -R 644 wp-content/themes/3000studiostheme-main" >> fix.sh
        shell: bash

      - name: ğŸ” Auto-Heal wp-login (if broken)
        run: |
          echo "Checking login page..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://3000studios.com/wp-login.php)
          if [ "$STATUS" != "200" ]; then
            echo "Login broken â€” restoring wp-login.phpâ€¦"
            curl -o restore.zip https://wordpress.org/latest.zip
            unzip restore.zip
            mv wordpress/wp-login.php wp-login.php
          else
            echo "Login OK âœ”"
          fi

      - name: ğŸ§¼ Clear WP Cache
        run: |
          curl -s https://3000studios.com/wp-admin/admin-ajax.php?action=flush_cache || true

      - name: ğŸ‰ Deployment Finished
        run: echo "ğŸ”¥ 3000studios theme updated successfully"
