name: 3000 Studios â€” MASTER WordPress Theme Sync (With Cleanup)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    name: ðŸš€ Sync WordPress Theme + Cleanup
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”¥ Checkout Repo
        uses: actions/checkout@v4

      - name: ðŸ“¦ Build Theme Package
        run: |
          mkdir -p dist/3000studiostheme-main
          rsync -av --exclude='.github' --exclude='node_modules' --exclude='dist' ./ dist/3000studiostheme-main/

      - name: ðŸ“¡ Deploy via SFTP (IONOS)
        uses: wlixcc/SFTP-Deploy-Action@v1.4.1
        with:
          server: ${{ secrets.IONOS_HOST }}
          username: ${{ secrets.IONOS_USER }}
          password: ${{ secrets.IONOS_PASS }}
          port: 22
          local_path: "dist/3000studiostheme-main/"
          remote_path: "/clickandbuilds/3000Studios/wp-content/themes/3000studiostheme-main"
          args: "-avz --delete"

      - name: ðŸ’£ CLEANUP â€” Delete all old theme folders
        run: |
          echo "Starting cleanupâ€¦"

          # Cleanup script
          CLEANUP_CMDS=$(cat <<'EOF'
          cd /clickandbuilds/3000Studios/wp-content/themes

          rm -rf 3000studios-clean
          rm -rf 3000studios-ready
          rm -rf 3000studios-ready-1
          rm -rf 3000studiostheme
          rm -rf 3000studiostheme-202*
          rm -rf 3000studios-202*
          EOF
          )

          # Execute cleanup via SFTP
          sudo apt-get update
          sudo apt-get install -y sshpass

          sshpass -p "${{ secrets.IONOS_PASS }}" ssh -o StrictHostKeyChecking=no ${{ secrets.IONOS_USER }}@${{ secrets.IONOS_HOST }} "$CLEANUP_CMDS"

      - name: ðŸ”§ Fix File Permissions
        run: |
          FIX_CMDS=$(cat <<'EOF'
          cd /clickandbuilds/3000Studios/wp-content/themes
          chmod -R 755 3000studiostheme-main
          EOF
          )

          sshpass -p "${{ secrets.IONOS_PASS }}" ssh -o StrictHostKeyChecking=no ${{ secrets.IONOS_USER }}@${{ secrets.IONOS_HOST }} "$FIX_CMDS"

      - name: ðŸ” Auto-Heal wp-login.php
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://3000studios.com/wp-login.php)
          if [ "$STATUS" != "200" ]; then
            echo "Login page broken â€” restoring WordPress core file"
            curl -o latest.zip https://wordpress.org/latest.zip
            unzip latest.zip
            cp wordpress/wp-login.php wp-login.php
          else
            echo "Login OK"
          fi

      - name: ðŸ§¼ Clear WP Cache
        run: |
          curl -s https://3000studios.com/wp-admin/admin-ajax.php?action=flush_cache || true

      - name: ðŸŽ‰ Deployment Finished
        run: echo "ðŸ”¥ Theme deployed and garbage cleared from server."
