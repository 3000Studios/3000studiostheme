# Copyright (c) 2025 Mr. jwswain - 3000 Studios. All Rights Reserved.
# Black Vault SUPREME Auto-Deploy Pipeline

name: 3000 Studios Auto-Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  THEME_NAME: 3000studios

jobs:
  auto-update-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ”¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          npm audit fix --force || true
      
      - name: ğŸ”¼ Bump Version
        id: version-bump
        run: |
          npm run version:bump
          echo "VERSION=$(grep 'Version:' style.css | sed 's/Version: //')" >> $GITHUB_ENV
          echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: ğŸ§¹ Clear Cache & Optimize
        run: |
          rm -rf node_modules/.cache
          rm -f *.backup.*
          rm -f 3000StudiosTheme_*.zip
          
      - name: ğŸ“¦ Package Theme
        run: |
          BUILD_TIME=$(date '+%Y-%m-%d_%H-%M-%S')
          ZIP_NAME="3000StudiosTheme_v${VERSION}_${BUILD_TIME}.zip"
          
          mkdir -p /tmp/3000studios
          rsync -av --exclude='.git' \
                    --exclude='node_modules' \
                    --exclude='.github' \
                    --exclude='*.backup.*' \
                    --exclude='*.log' \
                    ./ /tmp/3000studios/
          
          cd /tmp
          zip -r "$GITHUB_WORKSPACE/$ZIP_NAME" 3000studios/
          
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
      
      - name: ğŸš€ Deploy to WordPress (FTP)
        if: secrets.FTP_SERVER != ''
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: /wp-content/themes/3000studios/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/*.backup.*
            **/*.zip
            **/.github/**
      
      - name: ğŸ”„ Trigger Site Refresh
        if: secrets.SITE_REFRESH_URL != ''
        run: |
          curl -X POST "${{ secrets.SITE_REFRESH_URL }}/wp-json/wp/v2/refresh-theme" \
               -H "Authorization: Bearer ${{ secrets.WP_API_TOKEN }}" \
               || echo "âš ï¸  Refresh endpoint not available"
      
      - name: ğŸ“¤ Upload Theme Package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}
          retention-days: 30
      
      - name: ğŸ’ Create Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: 3000 Studios Theme v${{ env.VERSION }}
          body: |
            ğŸš€ **Black Vault SUPREME Auto-Deploy**
            
            **Version:** ${{ env.VERSION }}
            **Build Time:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.sha }}
            
            ### ğŸ”¥ What's New
            ${{ github.event.head_commit.message }}
            
            ### ğŸ“¦ Installation
            1. Download the theme ZIP
            2. Upload to WordPress via Appearance > Themes > Add New
            3. Activate and enjoy!
            
            ---
            Â© 2025 3000 Studios. All Rights Reserved.
          files: ${{ env.ZIP_NAME }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ¯ Auto-Commit Version Bump
        if: steps.version-bump.outputs.changed == 'true'
        run: |
          git config user.name "Black Vault SUPREME"
          git config user.email "ai@3000studios.com"
          git add style.css package.json
          git commit -m "ğŸš€ Auto-bump version to ${{ env.VERSION }}" || exit 0
          git push || exit 0
      
      - name: âœ… Deployment Complete
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… 3000 Studios Theme v${{ env.VERSION }} deployed"
          echo "ğŸ“¦ Package: ${{ env.ZIP_NAME }}"
          echo "ğŸŒ Live at: https://3000studios.com"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
