name: Cleanup Merged Branches

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours

permissions:
  contents: write

jobs:
  cleanup-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Delete merged branches except main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Fetching all branches..."
          git fetch --all
          
          echo "üìù Listing all remote branches..."
          BRANCHES=$(git branch -r | grep -v 'HEAD' | grep -v '/main$' | sed 's|origin/||' | tr -d ' ')
          
          echo "Found branches to potentially delete:"
          echo "$BRANCHES"
          
          # Check each branch to see if it's merged
          for branch in $BRANCHES; do
            echo ""
            echo "Checking branch: $branch"
            
            # Check if branch is merged into main
            if git merge-base --is-ancestor origin/$branch origin/main 2>/dev/null; then
              echo "‚úÖ Branch $branch is merged into main - DELETING"
              git push origin --delete "$branch" 2>&1 || echo "‚ö†Ô∏è  Failed to delete $branch (may already be deleted or protected)"
            else
              # Check commits unique to this branch
              UNIQUE_COMMITS=$(git log origin/main..origin/$branch --oneline 2>/dev/null | wc -l)
              if [ "$UNIQUE_COMMITS" -eq 0 ]; then
                echo "‚úÖ Branch $branch has no unique commits - DELETING"
                git push origin --delete "$branch" 2>&1 || echo "‚ö†Ô∏è  Failed to delete $branch"
              else
                echo "‚è≠Ô∏è  Branch $branch has $UNIQUE_COMMITS unique commits - SKIPPING"
              fi
            fi
          done
          
          echo ""
          echo "üéâ Branch cleanup complete!"
          echo "Remaining branches:"
          git branch -r
