name: Dev Inspector

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  inspect:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq php-cli nodejs npm pylint flake8
          npm install -g eslint markdownlint-cli

      - name: Scan & lint
        run: |
          echo "ðŸ§© Running linters"
          eslint . || true
          flake8 . || true
          php -l $(find . -type f -name "*.php") || true
          markdownlint '**/*.md' || true

      # --------------------------------------------------------
      # OPENAI STEP â€” correctly gated (NO secrets usage in "if")
      # --------------------------------------------------------
      - name: Call OpenAI API (curl)
        id: advisor
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-4' }}
        if: env.OPENAI_API_KEY != ''    # <- THIS is the correct way
        run: |
          set -euo pipefail

          prompt='You are 3000 Studios DevOps Planner.
          1. Read the linter / scan outputs from the current job.
          2. Produce a table with:
             â€¢ File
             â€¢ Issue summary
             â€¢ Fix priority (P1â€“P3)
          3. Then suggest a 3-phase plan:
             - Phase 1: urgent fixes
             - Phase 2: refactors + features
             - Phase 3: polish + monetization
          Keep it concise and actionable.'

          payload=$(jq -n \
            --arg model "$OPENAI_MODEL" \
            --arg prompt "$prompt" \
            '{model: $model, messages: [{role: "user", content: $prompt}], max_tokens: 800}')

          response=$(curl -f -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$payload") || {
              echo "Error: OpenAI API call failed"
              exit 1
            }

          echo "OpenAI response:"
          echo "$response"

          if echo "$response" | jq -e '.error' >/dev/null 2>&1; then
            echo "Error from OpenAI API:"
            echo "$response" | jq -r '.error.message'
            exit 1
          else
            echo "$response" | jq -r '.choices[0].message.content // "No response"' > /tmp/advisor_output.txt
          fi

          echo "text=/tmp/advisor_output.txt" >> $GITHUB_OUTPUT

      - name: Post Blueprint to Issues
        if: steps.advisor.outputs.text != ''
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ðŸ“‹ Dev-Inspector Report & Phase Blueprint"
          content-file: ${{ steps.advisor.outputs.text }}
          labels: ai, planning, backlog
