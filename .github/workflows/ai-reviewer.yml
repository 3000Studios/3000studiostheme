name: ðŸ¤– AI Reviewer
on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  pull-requests: write
  contents: read

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare PR context
        id: ctx
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            return { prNumber: pr.number, title: pr.title, user: pr.user.login, base: pr.base.ref, head: pr.head.ref };
      - name: Fetch diff
        id: diff
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { data } = await github.rest.pulls.get({
              owner: context.repo.owner, repo: context.repo.repo, pull_number: pr.number, mediaType: { format: 'diff' }
            });
            core.setOutput('diff', data);
      - name: Ask GPT for review
        id: gpt
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python3 - << 'PY'
          import os, json, textwrap, urllib.request
          import ssl
          ssl._create_default_https_context = ssl._create_unverified_context
          key=os.environ["OPENAI_API_KEY"]
          diff="""${{ steps.diff.outputs.diff }}"""
          prompt=f"Review this PR diff. Flag risky changes, security issues, and suggest improvements. Keep it under 300 words.\n\n{diff[:12000]}"
          data=json.dumps({"model":"gpt-4o-mini","messages":[{"role":"user","content":prompt}] }).encode()
          req=urllib.request.Request("https://api.openai.com/v1/chat/completions", data=data,
                                    headers={"Authorization":f"Bearer {key}","Content-Type":"application/json"})
          res=urllib.request.urlopen(req).read().decode()
          out=json.loads(res)["choices"][0]["message"]["content"]
          print(out)
          with open("ai-review.txt","w") as f: f.write(out)
          PY
      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('ai-review.txt','utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number, body
            });
