name: â˜ï¸ Google Drive Sync

on:
  schedule:
    - cron: "0 0 * * *"   # midnight UTC
  workflow_dispatch:

jobs:
  sync:
    if: vars.DRIVE_ENABLED == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: Restore rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONF_BASE64 }}" | base64 --decode > ~/.config/rclone/rclone.conf
          rclone version

      - name: Create upload folders if missing
        run: |
          rclone mkdir gdrive:${{ secrets.DRIVE_FOLDER_ID }}/reports || true
          rclone mkdir gdrive:${{ secrets.DRIVE_FOLDER_ID }}/logs || true
          rclone mkdir gdrive:${{ secrets.DRIVE_FOLDER_ID }}/changelogs || true
          rclone mkdir gdrive:${{ secrets.DRIVE_FOLDER_ID }}/backups || true

      - name: Upload nightly reports
        run: |
          echo "ðŸ” Syncing data to Google Drive..."
          rclone copy reports gdrive:${{ secrets.DRIVE_FOLDER_ID }}/reports --update --verbose || true
          rclone copy logs gdrive:${{ secrets.DRIVE_FOLDER_ID }}/logs --update --verbose || true
          rclone copy changelogs gdrive:${{ secrets.DRIVE_FOLDER_ID }}/changelogs --update --verbose || true
          rclone copy backups gdrive:${{ secrets.DRIVE_FOLDER_ID }}/backups --update --verbose || true
          echo "âœ… Sync complete"

      - name: Summarize upload results
        run: |
          echo "Nightly sync finished successfully on $(date -u)" > sync-summary.txt
          rclone copy sync-summary.txt gdrive:${{ secrets.DRIVE_FOLDER_ID }}/logs --update
