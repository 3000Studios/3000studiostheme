# Copyright (c) 2025 Mr. jwswain - 3000 Studios. All Rights Reserved.
# Command Center Automation - Auto-commit, push, review, merge, test, and deploy

name: ðŸŽ¯ Command Center Automation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'

env:
  THEME_NAME: 3000studios

jobs:
  lint-and-test:
    name: ðŸ” Lint & Validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: ðŸ”¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ§¹ Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: âœ… PHP Syntax Check
        run: |
          find . -name "*.php" -not -path "./node_modules/*" -print0 | xargs -0 -n1 php -l

      - name: ðŸ”Ž Check for Common Issues
        run: |
          echo "Checking for TODO/FIXME comments..."
          grep -r "TODO\|FIXME" --include="*.php" --include="*.js" . || echo "No TODOs found"

  auto-update:
    name: ðŸ”„ Auto-Update & Fix
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: ðŸ”¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ”§ Auto-fix Linting Issues
        run: |
          npm run lint -- --fix || true
          
      - name: ðŸ“ Check for Changes
        id: changes
        run: |
          git config user.name "3000 Studios Bot"
          git config user.email "ai@3000studios.com"
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ’¾ Auto-commit Changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git add .
          git commit -m "ðŸ¤– Auto-fix: Linting and code quality improvements"
          git push

  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: ðŸ”¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” Run npm audit
        run: npm audit --audit-level=moderate || true

      - name: ðŸ›¡ï¸ Check for Secrets
        run: |
          echo "Scanning for potential secrets..."
          ! grep -r "password\|api_key\|secret\|token" --include="*.php" --include="*.js" . | grep -v "example\|placeholder\|your_" || echo "âš ï¸  Potential secrets found"

  build-and-deploy:
    name: ðŸš€ Build & Deploy
    runs-on: ubuntu-latest
    needs: [lint-and-test, security-scan]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
    steps:
      - name: ðŸ”¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ”¼ Bump Version
        run: |
          npm run version:bump
          VERSION=$(grep 'Version:' style.css | sed 's/.*Version: *//' | tr -d ' ')
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: ðŸ“¦ Build Theme Package
        run: |
          BUILD_TIME=$(date '+%Y%m%d_%H%M%S')
          ZIP_NAME="3000studios-theme-v${VERSION}-${BUILD_TIME}.zip"
          
          echo "Building theme package: $ZIP_NAME"
          
          zip -r "$ZIP_NAME" . \
            -x "*.git*" \
            -x "node_modules/*" \
            -x "*.md" \
            -x "scripts/*" \
            -x "webhook-server/*" \
            -x "*.zip" \
            -x "*.log"
          
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: ðŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: theme-package
          path: ${{ env.ZIP_NAME }}
          retention-days: 30

      - name: âœ… Deployment Complete
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Theme v${{ env.VERSION }} built successfully"
          echo "ðŸ“¦ Package: ${{ env.ZIP_NAME }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  ui-update-check:
    name: ðŸŽ¨ UI Update Checker
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: ðŸ”¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“Š Check UI Components
        run: |
          echo "ðŸŽ¨ Checking UI components..."
          
          # Check for CSS files
          echo "CSS Files:"
          find . -name "*.css" -not -path "./node_modules/*" | wc -l
          
          # Check for JavaScript files
          echo "JavaScript Files:"
          find . -name "*.js" -not -path "./node_modules/*" | wc -l
          
          # Check for PHP templates
          echo "PHP Template Files:"
          find . -name "page-*.php" | wc -l
          
          # Check for CodePen embeds
          echo "Checking for CodePen snippets..."
          grep -r "codepen" --include="*.php" --include="*.js" . || echo "No CodePen snippets found"

      - name: ðŸ“¸ Generate UI Report
        run: |
          echo "# UI Update Report" > ui-report.md
          echo "" >> ui-report.md
          echo "**Generated:** $(date)" >> ui-report.md
          echo "" >> ui-report.md
          echo "## Files Summary" >> ui-report.md
          echo "- CSS Files: $(find . -name '*.css' -not -path './node_modules/*' | wc -l)" >> ui-report.md
          echo "- JS Files: $(find . -name '*.js' -not -path './node_modules/*' | wc -l)" >> ui-report.md
          echo "- PHP Templates: $(find . -name 'page-*.php' | wc -l)" >> ui-report.md

      - name: ðŸ“¤ Upload UI Report
        uses: actions/upload-artifact@v4
        with:
          name: ui-report
          path: ui-report.md
          retention-days: 7
