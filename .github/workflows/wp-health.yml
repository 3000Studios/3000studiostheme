name: WP Admin Health Monitor

on:
  schedule:
    - cron: "*/10 * * * *"   # every 10 minutes
  workflow_dispatch:

jobs:
  check-wp-admin:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§ª Check wp-admin HTTP status
        id: check
        run: |
          STATUS=$(curl -I -s https://3000studios.com/wp-admin | head -n 1 | awk '{print $2}')
          
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "302" ]; then
            echo "OK=1" >> $GITHUB_OUTPUT
          else
            echo "OK=0" >> $GITHUB_OUTPUT
          fi

      - name: ðŸŸ¥ Trigger Fix (if down)
        if: ${{ steps.check.outputs.OK == '0' }}
        run: |
          echo "[!] WP-ADMIN IS DOWN â€” ACTIVATING AUTO-FIX"

      - name: ðŸ”§ SSH Auto-Fix Script on Server
        if: ${{ steps.check.outputs.OK == '0' }}
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.WP_HOST }}
          username: ${{ secrets.WP_USER }}
          password: ${{ secrets.WP_PASS }}
          port: 22
          script: |
            echo "=== 3000 STUDIOS AUTO-REPAIR ==="

            # Restart PHP
            echo "[+] Restarting PHP..."
            /etc/init.d/php8.2-fpm restart || true

            # Rebuild .htaccess
            echo "[+] Rebuilding .htaccess..."
            cat > ~/html/.htaccess <<'EOF'
            # BEGIN WordPress
            <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.php$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.php [L]
            </IfModule>
            # END WordPress
            EOF

            # Reset permissions
            echo "[+] Fixing permissions..."
            chmod -R 755 ~/html
            find ~/html -type f -exec chmod 644 {} \;

            # Disable bad plugins
            echo "[+] Disabling problematic plugins..."
            mv ~/html/wp-content/plugins ~/html/wp-content/plugins_DISABLED || true

            echo "[+] Auto-fix complete."