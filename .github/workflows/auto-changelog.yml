name: ðŸ“ Auto Changelog (nightly)
on:
  schedule: [ { cron: "0 5 * * *" } ]  # 12:00 AM ET
  workflow_dispatch:

permissions:
  contents: write

jobs:
  changelog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Build nightly changelog
        run: |
          mkdir -p reports
          TODAY=$(date -u +%F)
          {
            echo "## ${TODAY}"
            echo
            git log --since="24 hours ago" --pretty="* %h %s (%an)"
            echo
          } >> reports/CHANGELOG.md
      - name: Commit changelog
        run: |
          git config user.name "3000 Studios Bot"
          git config user.email "bot@3000studios.com"
          git add reports/CHANGELOG.md
          git commit -m "chore(reports): nightly changelog" || echo "No changes"
          git push
      - name: Mirror to Google Drive (optional)
        if: env.DRIVE_ENABLED == 'true'
        env:
          DRIVE_ENABLED: ${{ vars.DRIVE_ENABLED }}
          RCLONE_CONF_BASE64: ${{ secrets.RCLONE_CONF_BASE64 }}
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
        run: |
          echo "$RCLONE_CONF_BASE64" | base64 -d > rclone.conf
          curl -fsSL https://rclone.org/install.sh | sudo bash
          rclone --config rclone.conf copy reports "gdrive:${DRIVE_FOLDER_ID}/reports" --create-empty-src-dirs
