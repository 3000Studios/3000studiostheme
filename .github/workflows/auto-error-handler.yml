# Copyright (c) 2025 Mr. jwswain - 3000 Studios. All Rights Reserved.
# Auto Error Handling and Fix System

name: ğŸ”§ Auto Error Handler

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'

env:
  THEME_NAME: 3000studios

jobs:
  detect-errors:
    name: ğŸ” Detect Code Errors
    runs-on: ubuntu-latest
    outputs:
      has_errors: ${{ steps.check.outputs.has_errors }}
      error_count: ${{ steps.check.outputs.error_count }}
    steps:
      - name: ğŸ”¥ Checkout Repository
        uses: actions/checkout@v4

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ” Check PHP Syntax
        id: php-check
        run: |
          echo "Checking PHP syntax..."
          ERROR_COUNT=0
          
          while IFS= read -r file; do
            if ! php -l "$file" > /dev/null 2>&1; then
              echo "âŒ Error in: $file"
              php -l "$file"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done < <(find . -name "*.php" -not -path "./node_modules/*")
          
          echo "php_errors=$ERROR_COUNT" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ” Check JavaScript Errors
        id: js-check
        run: |
          echo "Running ESLint..."
          npm run lint > eslint-report.txt 2>&1 || true
          
          if grep -q "error" eslint-report.txt; then
            echo "has_js_errors=true" >> $GITHUB_OUTPUT
            cat eslint-report.txt
          else
            echo "has_js_errors=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: ğŸ” Check for Common Issues
        id: common-check
        run: |
          echo "Checking for common issues..."
          
          # Check for syntax errors in CSS
          echo "CSS files check..."
          find . -name "*.css" -not -path "./node_modules/*" -exec echo "Checking: {}" \;
          
          # Check for missing semicolons in JS
          echo "Checking JavaScript..."
          grep -r "console\.log\|debugger" --include="*.js" --exclude-dir=node_modules . || echo "No debug code found"
          
          # Check for TODO/FIXME
          TODO_COUNT=$(grep -r "TODO\|FIXME" --include="*.php" --include="*.js" --exclude-dir=node_modules . | wc -l || echo "0")
          echo "todo_count=$TODO_COUNT" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Generate Error Report
        id: check
        run: |
          PHP_ERRORS=${{ steps.php-check.outputs.php_errors || 0 }}
          TODO_COUNT=${{ steps.common-check.outputs.todo_count || 0 }}
          
          TOTAL_ERRORS=$((PHP_ERRORS))
          
          if [ "$TOTAL_ERRORS" -gt 0 ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi
          
          echo "error_count=$TOTAL_ERRORS" >> $GITHUB_OUTPUT
          
          # Create report
          cat > error-report.md << EOF
          # ğŸ” Error Detection Report
          
          **Generated:** $(date)
          
          ## Summary
          - PHP Errors: $PHP_ERRORS
          - JavaScript Issues: ${{ steps.js-check.outputs.has_js_errors }}
          - TODOs Found: $TODO_COUNT
          - Total Critical Errors: $TOTAL_ERRORS
          
          ## Status
          $([ "$TOTAL_ERRORS" -eq 0 ] && echo "âœ… All checks passed!" || echo "âš ï¸ Issues detected - attempting auto-fix...")
          EOF

      - name: ğŸ“¤ Upload Error Report
        uses: actions/upload-artifact@v4
        with:
          name: error-report
          path: error-report.md
          retention-days: 7

  auto-fix:
    name: ğŸ”§ Auto-Fix Errors
    runs-on: ubuntu-latest
    needs: detect-errors
    if: needs.detect-errors.outputs.has_errors == 'true' && github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ”¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ”§ Auto-fix ESLint Issues
        run: |
          echo "Attempting to auto-fix JavaScript issues..."
          npm run lint -- --fix || true

      - name: ğŸ”§ Auto-fix PHP Issues
        run: |
          echo "Checking and attempting to fix common PHP issues..."
          # Remove trailing whitespace
          find . -name "*.php" -not -path "./node_modules/*" -exec sed -i 's/[[:space:]]*$//' {} \;

      - name: ğŸ“ Check for Changes
        id: changes
        run: |
          git config user.name "3000 Studios Auto-Fix Bot"
          git config user.email "ai@3000studios.com"
          
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¾ Commit Auto-fixes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git add .
          git commit -m "ğŸ¤– Auto-fix: Resolved ${{ needs.detect-errors.outputs.error_count }} error(s)"
          git push

  validate-fixes:
    name: âœ… Validate Fixes
    runs-on: ubuntu-latest
    needs: [detect-errors, auto-fix]
    if: always()
    steps:
      - name: ğŸ”¥ Checkout Repository
        uses: actions/checkout@v4

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: âœ… Final Validation
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” FINAL VALIDATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Run all checks
          echo "Running ESLint..."
          npm run lint
          
          echo "Checking PHP syntax..."
          find . -name "*.php" -not -path "./node_modules/*" -print0 | xargs -0 -n1 php -l
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All validations passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  notify-status:
    name: ğŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs: [detect-errors, auto-fix, validate-fixes]
    if: always()
    steps:
      - name: ğŸ“Š Summary
        run: |
          cat << EOF
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸ¯ ERROR HANDLING SUMMARY
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          Errors Detected: ${{ needs.detect-errors.outputs.error_count || 0 }}
          Auto-fix Applied: ${{ needs.auto-fix.result == 'success' && 'Yes' || 'No' }}
          Final Status: ${{ needs.validate-fixes.result == 'success' && 'âœ… PASSED' || 'âš ï¸ NEEDS ATTENTION' }}
          
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          EOF
